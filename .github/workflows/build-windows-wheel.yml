name: build-windows-wheel

on:
  workflow_dispatch:

jobs:
  wheel:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Make sure MSVC environment variables (cl.exe, link.exe) are available
      - name: Set up MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Ninja + vcpkg
        shell: pwsh
        run: |
          choco install -y ninja
          git clone https://github.com/microsoft/vcpkg $env:RUNNER_TEMP\vcpkg
          & $env:RUNNER_TEMP\vcpkg\bootstrap-vcpkg.bat
          & $env:RUNNER_TEMP\vcpkg\vcpkg.exe install zlib:x64-windows

      # CI-only patch: your build is passing `-G "Unix Makefiles"` on Windows
      # We replace it with Ninja so CMake uses MSVC + Ninja
      - name: Patch generator (CI only)
        shell: pwsh
        run: |
          $files = @("setup.py", "pyproject.toml")
          foreach ($f in $files) {
            if (Test-Path $f) {
              $content = Get-Content $f -Raw
              if ($content -match "Unix Makefiles") {
                Write-Host "Patching ${f}: Unix Makefiles -> Ninja"
                $content = $content -replace "Unix Makefiles", "Ninja"
                Set-Content -Path $f -Value $content -NoNewline
              } else {
                Write-Host "No Unix Makefiles found in ${f}"
              }
            } else {
              Write-Host "File not found: ${f}"
            }
          }

      - name: Build wheel
        shell: pwsh
        env:
          CMAKE_GENERATOR: Ninja
          VCPKG_DEFAULT_TRIPLET: x64-windows
          CMAKE_TOOLCHAIN_FILE: ${{ runner.temp }}\vcpkg\scripts\buildsystems\vcpkg.cmake
        run: |
          python -m pip install -U pip setuptools wheel cmake
          python -m pip wheel . -w dist
          dir dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: stable-retro-windows-wheel
          path: dist\*.whl
